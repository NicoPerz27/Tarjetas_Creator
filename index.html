<!DOCTYPE html>
<html lang="es">

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <meta charset="UTF-8">
  <title>Generar PDFs desde Excel</title>
  <style>
    .bg {
      background-color: #EEE;
      height: 100vh;
    }
  </style>
</head>

<body>
  <div class="bg text-center py-5">

    <h1>Generador de Tarjetas de Publicadors</h1>
    <p>Descarga el <a href="./plantilla.xlsx" download>excel</a> y llenalo en el formato compartido con los datos de
      cada publicador, y subelo aqui para generar las tarjetas de publicador</p>
    <div
      style="background-color:white; border-radius:7px; max-width:700px; box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;"
      class="mx-auto p-5 d-flex align-items-center justify-content-evenly">
      <div class="w-50">
        <input class="form-control" id="excelFile" accept=".xlsx, .xls" type="file">
      </div>
      <button class="btn-success" style="padding: 7.5px 25px; border-radius: 5px" id="process">Generar</button>
    </div>
    <div id="status" class="mt-3"></div>
    <!-- Instrucciones -->
    <div class="container my-5">
      <div class="p-4 bg-white rounded shadow">
        <h2 class="mb-3">üìã Instrucciones de uso</h2>
        <ol class="text-start">
          <li>Descarga el archivo Excel de ejemplo que contiene el formato correcto.</li>
          <li>En la primera columna indica el <strong>n√∫mero de grupo</strong> de cada publicador.</li>
          <li>En la segunda columna escribe el <strong>nombre completo</strong>.</li>
          <li>Completa los dem√°s campos (fechas, g√©nero, privilegios, etc.) siguiendo el orden establecido.</li>
          <li>Para los meses de septiembre a agosto (a√±o de servicio):
            <ul>
              <li>Escribe <strong>si</strong> para marcar participacion en el ministerio de ese mes.</li>
              <li>Si <strong>no</strong> particip√≥ en el ministerio ese mes, dejar la casilla en blanco.</li>
              <li>Escribe un n√∫mero (horas) para marcar participacion en el ministerio y registrar las horas en ese mes.
              </li>
              <li>En la columna siguiente, escribe <strong>si</strong>, s√≠ fue precursor auxiliar ese mes.</li>
            </ul>
          </li>
          <li>Guarda el archivo Excel y s√∫belo en este sitio.</li>
          <li>Haz clic en <strong>Generar</strong> para generar los PDFs.</li>
          <li>Se descargar√° un archivo ZIP con carpetas separadas por grupos.</li>
          <li>Descomprime el archivo y tendras todas las carpetas de cada grupo que indicaste y dentro cada miembro del
            grupo</li>
        </ol>
      </div>
    </div>
  </div>


  <!-- Librer√≠as externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const months = [
      "september", "october", "november", "december",
      "january", "february", "march", "april",
      "may", "june", "july", "august"
    ];

    // Normalizar cada fila a longitud fija
    function normalizarFila(row, totalCols) {
      const nueva = [];
      for (let i = 0; i < totalCols; i++) {
        nueva[i] = row[i] ?? "";
      }
      return nueva;
    }

    document.getElementById("process").addEventListener("click", async () => {
      const fileInput = document.getElementById("excelFile");
      if (!fileInput.files.length) {
        alert("Sube un archivo Excel primero");
        return;
      }

      const excelFile = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

        // Normalizar todas las filas
        const totalCols = rows[0].length;
        const registros = rows.slice(1).map(r => normalizarFila(r, totalCols));

        // cargar plantilla PDF
        const pdfBytes = await fetch("./plantilla.pdf").then(res => res.arrayBuffer());

        const zip = new JSZip();

        for (const row of registros) {
          if (!row[1]) continue; // el nombre es obligatorio (col 1)

          const grupo = row[0] || "sin_grupo"; // üëà primera columna = grupo
          const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
          const form = pdfDoc.getForm();

          // üîß Corrige fechas con a√±o de 2 d√≠gitos ‚Üí dd/mm/yyyy
          function fixShortYear(dateStr) {
            if (typeof dateStr !== "string") return dateStr;
            const parts = dateStr.split("/");
            if (parts.length !== 3) return dateStr;

            let [d, m, y] = parts.map(p => p.trim());

            // Si el a√±o tiene 2 d√≠gitos, lo expandimos
            if (y.length === 2) {
              const yearNum = parseInt(y, 10);
              y = yearNum > 30 ? `19${y}` : `20${y}`; // ajusta el umbral si lo deseas
            }

            return `${parseInt(d, 10)}/${parseInt(m, 10)}/${y}`;
          }

          try {
            const nombre = String(row[1] || "");
            const nacimiento = row[2] ? fixShortYear(String(row[2])) : "";
            const bautismo = row[3] ? fixShortYear(String(row[3])) : "";

            form.getTextField("full_name").setText(nombre);
            form.getTextField("birth_date").setText(nacimiento);
            form.getTextField("baptism_date").setText(bautismo);
          } catch (err) {
            console.warn("Error en campos b√°sicos", err);
          }

          // G√©nero (col 4)
          const gender = (row[4] || "").toString().toUpperCase();
          try {
            if (gender === "MASCULINO") form.getCheckBox("gender_male").check();
            if (gender === "FEMENINO") form.getCheckBox("gender_female").check();
          } catch { }

          // Other sheep / anointed (col 5)
          try {
            if (row[5] == "Otras Ovejas") form.getCheckBox("other_sheep").check();
            if (row[5] == "Ungido") form.getCheckBox("anointed").check();
          } catch { }

          if (row[6] == "si" || row[6] == "x") try { form.getCheckBox("elder").check(); } catch { }
          if (row[7] == "si" || row[7] == "x") try { form.getCheckBox("ministerial_servant").check(); } catch { }
          if (row[8] == "si" || row[8] == "x") try { form.getCheckBox("regular_pioner").check(); } catch { }
          if (row[9] == "si" || row[9] == "x") try { form.getCheckBox("special_pioner").check(); } catch { }
          if (row[10] == "si" || row[10] == "x") try { form.getCheckBox("missionary").check(); } catch { }

          // Meses con pionner y cursos
          months.forEach((month, i) => {
            const baseIndex = 11 + (i * 3);   // üëà cada mes ahora ocupa 3 columnas
            const valor = row[baseIndex];     // participaci√≥n u horas
            const pionnerVal = row[baseIndex + 1]; // precursor auxiliar
            const coursesVal = row[baseIndex + 2]; // cursos b√≠blicos

            // Participaci√≥n / horas
            if (valor !== "") {
              const strVal = String(valor).toLowerCase();
              try {
                if (strVal === "si") {
                  form.getCheckBox(month).check();
                } else if (!isNaN(valor)) {
                  form.getCheckBox(month).check();
                  form.getTextField(`${month}_hours`).setText(String(valor));
                }
              } catch (err) {
                console.warn(`Error en mes ${month}`, err);
              }
            }

            // Precursor auxiliar
            if (pionnerVal !== "") {
              const strPio = String(pionnerVal).toLowerCase();
              try {
                if (strPio === "si") {
                  form.getCheckBox(`${month}_pionner`).check();
                }
              } catch (err) {
                console.warn(`Error en pionner de ${month}`, err);
              }
            }

            // Cursos b√≠blicos
            if (coursesVal !== "") {
              try {
                form.getTextField(`${month}_courses`).setText(String(coursesVal));
              } catch (err) {
                console.warn(`Error en cursos de ${month}`, err);
              }
            }
          });

          // generar archivo en carpeta de grupo
          const pdfFinal = await pdfDoc.save();
          // üîß Limpieza avanzada de nombres de archivo (mantiene acentos visibles)
          function limpiarNombreArchivo(texto) {
            if (!texto) return "registro";
            return texto
              .normalize("NFD")               // separa letras y acentos (√ë ‚Üí N + ~)
              .replace(/[\u0300-\u036f]/g, "") // elimina marcas diacr√≠ticas (acentos)
              .replace(/√±/g, "n")              // reemplaza √±
              .replace(/√ë/g, "N")
              .replace(/[^a-zA-Z0-9_\- ]/g, "") // elimina s√≠mbolos extra√±os
              .trim()
              .replace(/\s+/g, "_");           // espacios ‚Üí guiones bajos
          }

          const nombre = limpiarNombreArchivo(row[1]);
          zip.folder(String(grupo)).file(`${nombre}.pdf`, pdfFinal);
        }

        // descargar zip
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, "registros.zip");

        document.getElementById("status").textContent = "‚úÖ PDFs generados correctamente";
      };

      reader.readAsArrayBuffer(excelFile);
    });
  </script>
</body>

</html>